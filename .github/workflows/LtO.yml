name: üõ† Build Android Kernel - Proton Clang 11

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        repository: Ponleuz12/kernel_realme_sm4250
        ref: stable
        path: kernel

    - name: üì¶ Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y bc build-essential libncurses-dev bison flex libssl-dev \
                            libelf-dev ccache libxml2-utils tar wget git

    - name: ‚öôÔ∏è Download Proton Clang 11
      run: |
        mkdir clang
        cd clang
        wget https://github.com/kdrag0n/proton-clang/archive/refs/tags/20200510.tar.gz
        tar -xzf 20200510.tar.gz --strip-components=1

    - name: üîß Setup GCC Toolchains
      run: |
        git clone --depth=1 https://github.com/arter97/aosp-gcc-arm64 gcc64
        git clone --depth=1 https://github.com/arter97/aosp-gcc-arm gcc32

    - name: üõ† Build Kernel
      working-directory: kernel
      env:
        ARCH: arm64
        SUBARCH: arm64
        CLANG_PATH: ${{ github.workspace }}/clang/bin
        GCC64: ${{ github.workspace }}/gcc64/bin
        GCC32: ${{ github.workspace }}/gcc32/bin
      run: |
        export PATH=$CLANG_PATH:$GCC64:$GCC32:$PATH

        export CROSS_COMPILE=aarch64-linux-android-
        export CROSS_COMPILE_ARM32=arm-linux-androideabi-
        export CC=clang
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
        export OBJCOPY=llvm-objcopy
        export OBJDUMP=llvm-objdump
        export STRIP=llvm-strip

        make O=out stock_defconfig
        make -j$(nproc --all) O=out

    - name: üì¶ Upload Kernel Image
      uses: actions/upload-artifact@v4
      with:
        name: Image.gz-dtb
        path: kernel/out/arch/arm64/boot/Image.gz-dtb
