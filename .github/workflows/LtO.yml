name: ğŸ›  Build Kernel - Proton Clang 11

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      CROSS_COMPILE: aarch64-linux-android-
      CROSS_COMPILE_COMPAT: arm-linux-androideabi-
      CLANG_TRIPLE: aarch64-linux-gnu-

    steps:
    - name: ğŸ“¥ Checkout Kernel Source
      uses: actions/checkout@v4
      with:
        repository: Ponleuz12/kernel_realme_sm4250
        ref: stable
        path: kernel

    - name: ğŸ§° Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y bc bison build-essential cpio curl flex \
          git libncurses-dev libssl-dev libelf-dev \
          python3 unzip wget xz-utils

    - name: ğŸ“¦ Download Proton Clang 11
      run: |
        mkdir clang
        wget -O clang.tar.gz https://github.com/kdrag0n/proton-clang/archive/refs/tags/20200510.tar.gz
        tar -xf clang.tar.gz -C clang --strip-components=1

    - name: ğŸ“‚ Set Environment Path
      run: echo "${{ github.workspace }}/clang/bin" >> $GITHUB_PATH

    - name: ğŸ” Show Clang Version
      run: clang --version

    - name: âš™ï¸ Kernel Defconfig
      run: |
        cd kernel
        mkdir -p out
        make O=out ARCH=arm64 stock_defconfig

    - name: ğŸš€ Build Kernel
      run: |
        cd kernel
        export PATH="${{ github.workspace }}/clang/bin:$PATH"
        make -j$(nproc) O=out \
          CC=clang \
          LD=ld.lld \
          AR=llvm-ar \
          NM=llvm-nm \
          OBJCOPY=llvm-objcopy \
          OBJDUMP=llvm-objdump \
          STRIP=llvm-strip \
          CROSS_COMPILE=${{ env.CROSS_COMPILE }} \
          CROSS_COMPILE_COMPAT=${{ env.CROSS_COMPILE_COMPAT }} \
          CLANG_TRIPLE=${{ env.CLANG_TRIPLE }}

    - name: ğŸ§µ Pack Image.gz-dtb
      run: |
        cd kernel
        IMAGE=out/arch/arm64/boot/Image.gz
        DTBS=$(find out/arch/arm64/boot/dts/qcom -name \"*.dtb\" | sort)
        if [ -f \"$IMAGE\" ] && [ ! -z \"$DTBS\" ]; then
          cat $IMAGE $DTBS > Image.gz-dtb
        else
          echo \"âŒ Image or DTBs missing\" && exit 1
        fi

    - name: ğŸ“¤ Upload Kernel Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Realme-C15-Kernel
        path: kernel/Image.gz-dtb
