name: Kernel Build with ThinLTO

on:
  workflow_dispatch:
  push:
    branches: [ stable ]

env:
  KERNEL_DIR: "kernel"
  CLANG_DIR: "clang-6443078"
  DEFCONFIG: "stock_defconfig"  # Verify this matches your actual defconfig

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout kernel source
      uses: actions/checkout@v4
      with:
        repository: Ponleuz12/kernel_realme_sm4250
        ref: stable
        path: ${{ env.KERNEL_DIR }}

    - name: Checkout Clang toolchain
      uses: actions/checkout@v4
      with:
        repository: techyminati/android_prebuilts_clang_host_linux-x86_clang-6443078
        ref: 11.0.1
        path: ${{ env.CLANG_DIR }}

    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential flex bison libssl-dev libelf-dev \
          bc python3 git make gcc zip

    - name: Verify toolchain
      run: |
        echo "=== Toolchain Verification ==="
        ${{ github.workspace }}/${{ env.CLANG_DIR }}/bin/clang --version
        ${{ github.workspace }}/${{ env.CLANG_DIR }}/bin/ld.lld --version
        echo "=== Defconfig Exists ==="
        ls ${{ github.workspace }}/${{ env.KERNEL_DIR }}/arch/arm64/configs/ | grep "${{ env.DEFCONFIG }}"

    - name: Build with ThinLTO
      run: |
        cd ${{ env.KERNEL_DIR }}
        
        export ARCH=arm64
        export SUBARCH=arm64
        export LLVM=1
        export LLVM_IAS=1
        export PATH="${{ github.workspace }}/${{ env.CLANG_DIR }}/bin:$PATH"
        export CLANG_TRIPLE=aarch64-linux-gnu-
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
        
        # Clean previous builds
        make O=out clean
        
        # Configure ThinLTO (corrected flags)
        echo "CONFIG_LTO_CLANG=y" >> arch/arm64/configs/${{ env.DEFCONFIG }}
        echo "CONFIG_THINLTO=y" >> arch/arm64/configs/${{ env.DEFCONFIG }}
        echo "CONFIG_LD_IS_LLD=y" >> arch/arm64/configs/${{ env.DEFCONFIG }}
        
        # Build with corrected ThinLTO flags
        make O=out ${{ env.DEFCONFIG }}
        
        make -j$(nproc --all) O=out \
          CC="clang" \
          LD="ld.lld" \
          AR="llvm-ar" \
          NM="llvm-nm" \
          STRIP="llvm-strip" \
          OBJCOPY="llvm-objcopy" \
          KCFLAGS="-flto=thin" \
          LDFLAGS="--thinlto-cache-dir=${GITHUB_WORKSPACE}/thinlto_cache" \
          2>&1 | tee build.log

    - name: Check build output
      run: |
        cd ${{ env.KERNEL_DIR }}
        if [ -f "out/arch/arm64/boot/Image.gz-dtb" ]; then
          echo "::notice::Build successful!"
          ls -lh out/arch/arm64/boot/
        else
          echo "::error::Build failed"
          grep -i "error:" build.log
          exit 1
        fi

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          ${{ env.KERNEL_DIR }}/build.log
          ${{ env.KERNEL_DIR }}/out/.config
